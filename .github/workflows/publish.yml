name: "Publish Python Package"
on:
  workflow_run:
    workflows: ["Specklepy test and build"]
    branches: [v3-dev]
    types:
      - completed


jobs:
  test-pypi-publish:
    name: Upload to TestPyPI
    if: github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    environment:
      name: testpypi
    permissions:
      id-token: write
      contents: read
    steps:
      - name: "Install uv"
        uses: astral-sh/setup-uv@v5
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Build artifacts"
        run: uv build
      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist/
      - name: Test package install
        run: uv run --index test --with specklepy --no-project -- python -c "import specklepy"
