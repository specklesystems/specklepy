# Publish a release to PyPI.
name: "Publish to PyPI"

on:

  # triggers publish to test pypi when merge into v3-dev
  workflow_run:
    workflows: ["Specklepy test and build"]
    branches: [v3-dev]
    types:
      - completed

  # triggers publish to pypi when a release is cut (or a tag created)
  release:
    types: [created]

jobs:
  pypi-publish:
    name: Upload to PyPI
    runs-on: ubuntu-latest
    steps:
      - name: "Install uv"
        uses: astral-sh/setup-uv@v5
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # build the package
      - name: "Build artifacts"
        run: uv build

      # for merges
      - name: Publish to Test PyPI
        if: github.event_name == 'workflow_run'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

      # for releases
      - name: Publish to PyPI
        if: github.event_name == 'release'
        uses: pypa/gh-action-pypi-publish@release/v1

      # test installation
      - name: Test package install from Test PyPI
        if: github.event_name == 'workflow_run'
        run: uv run --index test --with specklepy --no-project -- python -c "import specklepy"

      - name: Test package install from PyPI
        if: github.event_name == 'release'
        run: uv run --with specklepy --no-project -- python -c "import specklepy"
