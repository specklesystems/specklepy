name: "Publish to PyPI"
on:
  # triggers publish to test pypi when merge into v3-dev
  workflow_run:
    workflows: ["Specklepy test and build"]
    branches: [v3-dev]
    types:
      - completed
  # triggers publish to pypi when a tag is created
  push:
    tags:
      - 'v*'
jobs:
  pypi-publish:
    name: Upload to PyPI
    runs-on: ubuntu-latest
    steps:
      - name: "Install uv"
        uses: astral-sh/setup-uv@v5
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # build the package
      - name: "Build artifacts"
        run: uv build
      # for merges - secret name is artificial
      - name: Publish to Test PyPI
        if: github.event_name == 'workflow_run'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
      # for tags - again, secret name...
      - name: Publish to PyPI
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
      # test installation
      - name: Test package install from Test PyPI
        if: github.event_name == 'workflow_run'
        run: uv run --index test --with specklepy --no-project -- python -c "import specklepy"
      - name: Test package install from PyPI
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        run: uv run --with specklepy --no-project -- python -c "import specklepy"
