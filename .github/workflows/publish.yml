name: "Publish Python Package"
on:
  workflow_run:
    workflows: [Specklepy test and build]
    types:
      - completed

jobs:
  publish-package:
    name: "Build and Publish Python Package"
    runs-on: ubuntu-latest

    # set the environment based on what triggered the workflow
    environment:
      name: ${{ contains(github.ref, 'refs/tags/v3') && 'pypi' || 'testpypi' }}

    permissions:
      id-token: write

    steps:
      - name: "Install uv"
        uses: astral-sh/setup-uv@v5

      - name: "Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Build package artifacts"
        run: uv build

      # Logic for TestPyPI (on v3-dev branch push)
      - name: "Publish to TestPyPI"
        if: ${{ !contains(github.ref, 'refs/tags/v3') }}
        run: uv publish --index test

      - name: "Verify TestPyPI package installation"
        if: ${{ !contains(github.ref, 'refs/tags/v3') }}
        run: uv run --index test --with specklepy --no-project -- python -c "import specklepy"

      # Logic for PyPI (on v3* tag creation)
      - name: "Publish to PyPI"
        if: ${{ contains(github.ref, 'refs/tags/v3') }}
        run: uv publish

      - name: "Verify PyPI package installation"
        if: ${{ contains(github.ref, 'refs/tags/v3') }}
        run: uv run --with specklepy --no-project -- python -c "import specklepy"
